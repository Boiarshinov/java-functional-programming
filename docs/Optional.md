# Optional #

Класс `Optional` является оберткой над объектами, которые могут принимать значение null.
`Optional` является примером реализации монады `Maybe` в Java.


## Контракт класса ##

Все методы класса `Optional` можно разбить на несколько групп:  
  
**Фабричные методы**
- `static Optional<T> empty()` - возвращает пустой `Optional` с null вместо значения.
- `static Optional<T> ofNullable(T)` - оборачивает объект, который может содержать в себе ссылку на *null*.
- `static Optional<T> of(T)` - оборачивает объект, при этом не производит проверку на *null*.

**Развертывание**
- `T get()` - возвращает обернутое значение. Если внутри *null*, то будет выкинуто исключение `NoSuchElementException`.
- `T orElse(T)` - заменяет тернарный оператор: если значение по вызывающей ссылке не равно *null*, то возвращается 
это значение, а если равно *null*, то возвращается объект, указанный в скобках.
- `T orElseGet(Supplier<T>)` - если значение по вызывающей ссылке не равно *null*, то возвращается это значение, 
а если равно *null*, то возвращается объект, полученный с помощью аргумента-поставщика.
- `T orElseThrow(Supplier<X>)` - возвращает значение. Если ссылка указывает на *null*, то бросает исключение, 
полученное с помощью аргумента-поставщика.

**Потоковые (стримовые) методы**
- `Optional<T> filter(Predicate<T>)` - проверяет соответствие значения внутри `Optional` заданному условию, если нет, 
то возвращает пустой `Optional`.
- `Optional<U> map(Function<T, U>)` - если обернутый объект существует, то применяет к нему переданную функцию и 
возвращает значение, обернутое в `Optional`, иначе возвращает пустой `Optional` нужного типа.
- `Optional<U> flatMap(Function<T, Optional<U>>)` - похож на предыдущий метод, но используется в случаях, если 
переданная функция сама по себе возвращает значение `Optional`, что позволяет избавиться от двойного обертывания. 
В контексте функциональных ЯП этот метод называется *bind*.

**Прочие методы**
- `boolean isPresent()` - сообщает есть ли значение внутри `Optional` - *true*, или там пустая ссылка (*null*) - *false*
- `void ifPresent(Consumer<T>)` - Если внутри не `null`, то выполняет действие, указанное в скобках

**Нововведения Java 9**
- `Stream<Optional<T>> stream()` - возвращает стрим из `Optional`. Метод позволяет легче оперировать `Optional`'ами 
в стримах.
- `void ifPresentOrElse(Consumer<T>, Runnable)` - если элемент существует, то передает его в потребителя, 
а если отсутствует, то выполняет действие, переданное вторым аргументом.
- `Optional<T> or(Supplier<Optional<T>>)` - Если объект существует, то `Optional` остается без изменений, а если нет, 
то он поставляется суплаером. Метод позволяет строить цепочки обработки:
```java
Optional<String> result = wordFromCache
    .or(() -> this.wordsRepo.getWord(id))
    .or(() -> this.anotherWordsService.getWord(id))
    .or(() -> this.getDefaultWord());
```


## Применение ##

Класс используется, для того чтобы предупредить пользователей API, что метод может возвращать *null* вместо объектов. 
Тем самым пользователи вынуждены будут проверить пришедшее значение на *null* прежде чем использовать его.  
До появления `Optional` экспертами рекомендовалось в тех случаях, когда метод может возвращать *null* вместо объекта, 
возвращать одинарный массив или список, заставляя тем самым пользователя API проверять, а содержится ли объект в 
этом массиве / списке.

Вместо подобной конструкции, использующей lazy оператор *AND*:
```java
if (object != null && object.getName().equals("Vovan loh")) {
    doSomething();
}
```
можно писать симпатично
```java
Optional.ofNullable(object)
    .filter(object.getName().equals("Vovan loh"))
    .ifPresent(() -> doSomething());
```

Также можно использовать `Optional`, если необходимо подменить какой-либо ресурс, который в результате предыдущих 
операций мог оказаться *null*:
```java
CustomObject result = Optional.ofNullable(object).orElseGet(CustomObject::new)
```
Такой подход позволяет не писать загромождающие код if'ы
```java
CustomObject result = object;
if (result == null) {
    result = new CustomObject();
}
```

__Не рекомендуется:__
- Использовать `Optional` в сеттерах и геттерах.
- Заворачивать в `Optional` коллекцию или массив, лучше вместо этого передать пустую коллекцию или массив.
- Передавать `Optional` в виде одного из аргументов метода. Вместо этого лучше сделать перегруженный вариант этого 
метода, где аргумент будет отсутствовать.

__Рекомендуется:__
- Использовать `Optional` когда нужно показать, что какое-то возвращаемое значение может не иметь значения и это 
абсолютно нормально. В таком случае null в этом поле будет говорить об ошибке, а Optional.empty() о нормальном 
поведении. Это и есть главное предназначение `Optional` под задумке архитекторов Java.
- Использовать `Optional` там, где раньше были "магические числа (объекты)".
- В методах-генераторах данных. Например при получении данных из БД.
- Использовать `Optional` для выборочного подключения зависимости к компоненту в рантайме.


## Недостатки `Optional` ##

- Optional не реализует интерфейс `Serializable`, что ограничивает использование объектов типа `Optional` в качестве 
сериализованных данных.
- Некоторые фреймворки, использующие рефлексию, могут неверно сравнивать между собой объекты `Optional`. **Jackson** и 
**Hibernate** поддерживают его, но другие менее популярные библиотеки могут сломаться.


## Источники ##

- [x] Javadoc на класс `Optional` (EN).
- [x] Гайд по `Optional` от Oracle (EN). [Oracle][Oracle]
- [x] Паттерны и антипаттерны использования `Optional` (EN). [DZone][DZone]
- [x] Ответ архитектора Java по use-case'ам использования `Optional` (EN). [StackOverflow][SO]
- [x] Серия статей: Объект в футляре или Optional в Java 8 и Java 9. (RU) (2018):
  - [x] Часть 1. Введение. [Хабр][Habr_1]
  - [x] Часть 2. Методы Optional в Java 8. [Хабр][Habr_2]
  - [x] Часть 3. Методы Optional в Java 9. [Хабр][Habr_3]
  - [x] Часть 4. Творчество автора по улучшению Optional. [Хабр][Habr_4]
  - [x] Часть 5. Практические рекомендации по использованию Optional. [Хабр][Habr_5]

[Oracle]: https://www.oracle.com/technical-resources/articles/java/java8-optional.html
[DZone]: https://dzone.com/articles/java-8-optional-use-cases
[SO]: https://stackoverflow.com/questions/26327957/should-java-8-getters-return-optional-type/26328555#26328555
[Habr_1]: https://habr.com/ru/post/347480/
[Habr_2]: https://habr.com/ru/post/347576/
[Habr_3]: https://habr.com/ru/post/347748/
[Habr_4]: https://habr.com/ru/post/347836/
[Habr_5]: https://habr.com/ru/post/350904/


